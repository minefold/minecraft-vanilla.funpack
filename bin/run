#!/usr/bin/env ruby
require 'time'
require 'json'

$LOAD_PATH << File.expand_path('../../lib', __FILE__)

require 'log_transformer'


# ---


STDOUT.sync = true
STDIN.sync = true

# usage: ./run <config>

config_path = ARGV.first
root = File.expand_path('../..', __FILE__)

# TODO This is a hack while Pinky doesn't support preparing funpacks.
system(File.join(root, 'bin', 'prepare'), config_path)

config = JSON.parse(File.read(config_path))

ram_min = config['ram']['min']
ram_max = config['ram']['max']

cmd = [ "java",
        "-Xms#{ram_min}M",
        "-Xmx#{ram_max}M",
        "-jar", "server.jar",
        "nogui",
        err: [:child, :out]]

IO.popen(cmd) do |io|
  LogTransformer.new(io).process!
end
